<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Horizon — Login</title>

    <!-- Fonts & Tailwind -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial,
            'Apple Color Emoji', 'Segoe UI Emoji';
        }
    </style>
</head>

<body class="bg-slate-950 text-white min-h-screen">
    <!-- Decorative horizon gradient background -->
    <div class="pointer-events-none fixed inset-0 -z-10">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950"></div>
        <div class="absolute inset-x-0 top-[-30%] h-[140vh] bg-[radial-gradient(140rem_60rem_at_50%_15%,rgba(45,212,191,0.22),transparent_75%)]"></div>
    </div>

    <!-- Centered card -->
    <main class="relative z-10 flex min-h-screen items-center justify-center px-4">
        <div class="w-full max-w-md">
            <div class="mb-6 text-center">
                <img src="{{ request.url_for('static', path='images/horizon-logo.png') }}" alt="Horizon logo"
                class="inline-block h-12 w-12 rounded-full object-cover shadow-lg shadow-teal-500/20"
                onerror="this.style.display='none'; this.nextElementSibling.style.display='inline-block';" />
                <h1 class="mt-4 text-2xl font-semibold tracking-tight">Sign in to <span class="bg-gradient-to-r from-teal-300 via-cyan-300 to-teal-300 bg-clip-text text-transparent">Horizon</span></h1>
                <p class="mt-1 text-sm text-slate-400">Secure, one-time code via email.</p>
            </div>

            <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur">
                <!-- STEP 1: Enter Email -->
                <form id="emailForm" class="space-y-4">
                    <div>
                        <label for="emailInput" class="mb-1 block text-sm font-medium text-slate-200">
                            Email
                        </label>
                        <input
                            type="email"
                            id="emailInput"
                            required
                            placeholder="you@example.com"
                            class="w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                        />
                    </div>
                    <button
                        type="submit"
                        class="mt-2 w-full rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2.5 text-sm font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95 disabled:cursor-not-allowed disabled:opacity-60"
                    >
                        Send Code
                    </button>
                </form>

                <!-- STEP 2: Enter Code (hidden at first) -->
                <form id="codeForm" style="display:none;" class="space-y-4">
                    <p class="text-sm text-slate-300">
                        A 6-digit code was sent to <span id="codeEmail" class="font-semibold text-white"></span>
                    </p>
                    <div>
                        <label for="codeInput" class="mb-1 block text-sm font-medium text-slate-200">
                            Verification code
                        </label>
                        <input
                            type="text"
                            id="codeInput"
                            placeholder="123456"
                            maxlength="6"
                            pattern="[0-9]{6}"
                            required
                            oninput="this.value=this.value.replace(/[^0-9]/g,'')"
                            class="w-full rounded-xl border border-white/10 bg-slate-950/60 px-4 py-3 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60 tracking-[0.3em] text-center"
                        />
                    </div>
                    <button
                        type="submit"
                        class="mt-2 w-full rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2.5 text-sm font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95 disabled:cursor-not-allowed disabled:opacity-60"
                    >
                        Verify
                    </button>
                    <button
                        id="backToEmail"
                        type="button"
                        class="w-full rounded-xl border border-white/10 bg-slate-900/60 px-4 py-2.5 text-sm font-semibold text-slate-300 shadow-inner shadow-black/20 transition hover:bg-slate-800/60"
                    >
                        Go Back
                    </button>

                </form>

                <!-- Status message -->
                <p id="statusMsg" class="mt-4 text-xs text-center text-slate-400"></p>
            </div>

            <p class="mt-4 text-center text-[11px] text-slate-500">
                For security, codes expire after a short time.
            </p>
        </div>
    </main>

    <script>
        const emailForm = document.getElementById('emailForm');
        const codeForm = document.getElementById('codeForm');

        const emailInput = document.getElementById('emailInput');
        const codeInput = document.getElementById('codeInput');

        const statusMsg = document.getElementById('statusMsg');

        let savedEmail = "";

        emailForm.addEventListener('submit', async function (e) {
            e.preventDefault();
            savedEmail = emailInput.value.trim();
            statusMsg.textContent = '';

            try {
                const res = await fetch('/auth/code/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: savedEmail })
                });

                if (res.ok) {
                    // Move to Step 2
                    emailForm.style.display = 'none';
                    codeForm.style.display = 'block';
                    const codeEmailSpan = document.getElementById('codeEmail');
                    if (codeEmailSpan) {
                        codeEmailSpan.textContent = savedEmail;
                    }
                    statusMsg.textContent = 'If you don’t receive an email, please click "Go Back" and submit your email again.';
                } else {
                    console.error("Error requesting code");
                    statusMsg.textContent = 'Something went wrong requesting your code. Please try again.';
                }
            } catch (err) {
                console.error(err);
                statusMsg.textContent = 'Network error. Please try again.';
            }
        });

        codeForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            const code = codeInput.value.trim();
            statusMsg.textContent = '';

            try {
                const res = await fetch('/auth/code/verify', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: savedEmail, code })
                });

                if (res.ok) {
                    window.location.href = "/";
                } else {
                    console.error("Invalid code");
                    statusMsg.textContent = 'Invalid code. Please check the code and try again. If the problem persists, you can go back and request a new code.';
                }
            } catch (err) {
                console.error(err);
                statusMsg.textContent = 'Network error. Please try again.';
            }
        });

        document.getElementById('backToEmail').addEventListener('click', () => {
            savedEmail = "";
            emailInput.value = "";
            codeInput.value = "";
            statusMsg.textContent = "";

            codeForm.style.display = 'none';
            emailForm.style.display = 'block';
        });
    </script>
</body>
</html>
