<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Horizon — Basket Details — {{ basket.name }}</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
</style>
</head>

<body class="bg-slate-950 text-white min-h-screen">
    <!-- Decorative horizon gradient background -->
    <div class="pointer-events-none fixed inset-0 -z-10">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950"></div>
        <div class="absolute inset-x-0 top-[-30%] h-[140vh] bg-[radial-gradient(140rem_60rem_at_50%_15%,rgba(45,212,191,0.22),transparent_75%)]"></div>
    </div>

    {% include 'modules/header.html' %}

    <!-- Main -->
    <main class="relative z-10">
        <div class="mx-auto max-w-8xl px-6 py-8 space-y-6">
            <!-- Back + Title row -->
            <div class="grid grid-cols-3 items-center">
                <div class="text-left">
                <a href="/" class="inline-flex items-center text-xs font-medium text-slate-300 hover:text-white">
                    <span class="mr-1">&larr;</span>
                    Back to your Baskets
                </a>
                </div>
                <div class="text-center">
                <h1 class="text-xl font-semibold tracking-tight sm:text-2xl">
                    Basket Details
                </h1>
                </div>
                <div class="text-right">
                <!-- empty placeholder to balance the left link -->
                </div>
            </div>

            <!-- LEFT SIDE -->
            <div class="grid grid-cols-1 gap-6 lg:grid-cols-[1.4fr_1fr]">
                <div class="space-y-6">
                    <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur">
                        <canvas id="basketChart" class="w-full h-64"></canvas>

                        <!-- Period buttons -->
                        <div id="periodButtons"
                            class="mt-4 mx-auto flex gap-1 rounded-full bg-slate-950/60 px-1.5 py-1 shadow-inner shadow-slate-950/60 border border-white/10 w-fit">
                            <button type="button" data-range="5D" class="range-btn px-2.5 py-1 text-[11px] font-medium rounded-full text-slate-300 hover:text-white hover:bg-slate-800/80 transition">
                                5D
                            </button>
                            <button type="button" data-range="1M" class="range-btn range-btn--active px-2.5 py-1 text-[11px] font-medium rounded-full text-slate-900 bg-teal-400 shadow-sm shadow-teal-500/40 border border-teal-400">
                                1M
                            </button>
                            <button type="button" data-range="3M" class="range-btn px-2.5 py-1 text-[11px] font-medium rounded-full text-slate-300 hover:text-white hover:bg-slate-800/80 transition">
                                3M
                            </button>
                            <button type="button" data-range="6M" class="range-btn px-2.5 py-1 text-[11px] font-medium rounded-full text-slate-300 hover:text-white hover:bg-slate-800/80 transition">
                                6M
                            </button>
                            <button type="button" data-range="1Y" class="range-btn px-2.5 py-1 text-[11px] font-medium rounded-full text-slate-300 hover:text-white hover:bg-slate-800/80 transition">
                                1Y
                            </button>
                        </div>
                    </div>
                    <div
                        id="basketCard"
                        class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur"
                        data-basket-id="{{ basket.id }}">
                        <div class="flex items-start justify-between gap-4">
                            <div>
                                <h2 class="text-xl font-semibold text-white">
                                {{ basket.name or "Untitled Basket" }}
                                </h2>
                                {% if basket.description %}
                                <p class="mt-1 text-sm text-slate-300">
                                    {{ basket.description }}
                                </p>
                                {% endif %}
                            </div>
                            <span
                                id="basketStatus"
                                class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium
                                    {% if basket.status == 'Active' %}
                                        border-teal-500/40 bg-teal-500/15 text-teal-300
                                    {% else %}
                                        border-slate-600/60 bg-slate-800/80 text-slate-300
                                    {% endif %}"
                            >
                                {{ basket.status or "Draft" }}
                            </span>
                        </div>

                        <!-- Holdings -->
                        <div class="mt-6 overflow-x-auto rounded-2xl border border-white/10 bg-slate-950/60">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-900/80">
                            <tr>
                                <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                Ticker
                                </th>
                                <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                Name
                                </th>
                                <th class="px-4 py-2 text-right text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                Weight
                                </th>
                                <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                Rationale
                                </th>
                            </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-800/80">
                            {% for h in basket.holdings %}
                                <tr class="cursor-pointer hover:bg-slate-900/70" onclick="toggleRow('{{ h.ticker }}')">
                                    <td class="px-4 py-2 align-top text-sm font-medium text-slate-100">
                                        {{ h.ticker or '—' }}
                                    </td>
                                    <td class="px-4 py-2 align-top text-sm text-slate-200">
                                        {{ h.name or '—' }}
                                    </td>
                                    <td class="px-4 py-2 align-top text-right text-sm tabular-nums text-slate-200">
                                        {{ "%.2f"|format(h.weight_pct or 0) }}%
                                    </td>
                                    <td class="px-4 py-2 align-top text-sm text-slate-300">
                                        {{ h.rationale or '' }}
                                    </td>
                                </tr>
                                {% set f = fundamentals_map.get(h.security_id) %}
                                <tr id="details-{{ h.ticker }}" class="hidden bg-slate-950/60">
                                    <td colspan="4" class="px-6 py-4">
                                        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-xs">
                                            <div>
                                                <span class="text-slate-400">Open</span>
                                                <div class="text-slate-200 font-medium">${{ f.open if f and f.open else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">High</span>
                                                <div class="text-slate-200 font-medium">${{ f.day_high if f and f.day_high else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">Low</span>
                                                <div class="text-slate-200 font-medium">${{ f.day_low if f and f.day_low else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">Mkt Cap</span>
                                                <div class="text-slate-200 font-medium">${{ f.market_cap if f and f.market_cap else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">P/E ratio</span>
                                                <div class="text-slate-200 font-medium">{{ f.pe_ratio if f and f.pe_ratio else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">52W high</span>
                                                <div class="text-slate-200 font-medium">${{ f.fifty_two_week_high if f and f.fifty_two_week_high else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">52W low</span>
                                                <div class="text-slate-200 font-medium">${{ f.fifty_two_week_low if f and f.fifty_two_week_low else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">Dividend rate</span>
                                                <div class="text-slate-200 font-medium">${{ f.dividend_rate if f and f.dividend_rate else '—' }}</div>
                                            </div>
                                            <div>
                                                <span class="text-slate-400">Dividend yield</span>
                                                <div class="text-slate-200 font-medium">{{ f.dividend_yield*100 if f and f.dividend_yield else '—' }}%</div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                        </div>

                        <p class="mt-3 text-xs text-slate-400">
                        Holdings:
                        <span class="font-semibold text-slate-200">{{ basket.holdings|length }}</span>
                        </p>

                        <!-- Actions -->
                        <div class="mt-5 flex flex-wrap items-center gap-3">
                        {% if basket.status == 'Draft' %}
                        <button
                            id="acceptBtn"
                            class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95"
                        >
                            Accept
                        </button>
                        {% endif %}

                        <button
                            id="editBtn"
                            class="inline-flex items-center justify-center rounded-xl border border-white/15 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 shadow-sm hover:bg-slate-900"
                        >
                            Edit
                        </button>

                        <button
                            id="deleteBtn"
                            class="inline-flex items-center justify-center rounded-xl border border-red-500/40 bg-red-600/20 px-4 py-2 text-xs font-semibold text-red-200 shadow-sm hover:bg-red-600/30"
                        >
                            Delete
                        </button>

                        <span id="actionStatus" class="text-xs text-slate-400"></span>
                        </div>
                    </div>
                </div>

                <!-- RIGHT SIDE: AI Suggestions -->
                <div>
                    <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur space-y-4">
                        <h2 class="text-lg font-semibold text-white">Today's AI Suggestions</h2>
                        <div id="suggestionsContainer" class="space-y-2">
                            <!-- Dynamically render suggestions here -->
                        </div>
                        <span id="suggestionsStatus" class="text-xs text-slate-400"></span>
                    </div>
                </div>

            </div>
        </div>
    </main>
</body>
</html>

<script>
    const card = document.getElementById('basketCard');
    const basketId = card.dataset.basketId;
    const statusPill = document.getElementById('basketStatus');
    const actionStatus = document.getElementById('actionStatus');
    const acceptBtn = document.getElementById('acceptBtn');
    const editBtn = document.getElementById('editBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    async function acceptFn() {
    try {
        const res = await fetch(`/baskets/accept`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ basket_id: basketId })
        });
        if (!res.ok) throw new Error(`Accept failed (${res.status})`);
            window.location.href = `/`;
    } catch (e) {
        console.error(e);
        actionStatus.textContent = 'Action failed.';
    }
    }

    async function deleteFn() {
    if (!confirm('Are you sure you want to delete this basket? This action cannot be undone.')) {
        return;
    }
    try {
        const res = await fetch(`/baskets/delete`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ basket_id: basketId })
        });
        if (!res.ok) throw new Error(`Delete failed (${res.status})`);
            window.location.href = `/`;
    } catch (e) {
        console.error(e);
        actionStatus.textContent = 'Action failed.';
    }
    }

    if (acceptBtn) {
        acceptBtn.addEventListener('click', () => acceptFn());
    }
    deleteBtn.addEventListener('click', () => deleteFn());
    editBtn.addEventListener('click', () => (window.location.href = `/baskets/edit?basket_id=${basketId}`));

    function toggleRow(id) {
        const row = document.getElementById(`details-${id}`);
        row.classList.toggle("hidden");
    }
</script>

<!-- SUGGESTIONS LOGIC (FETCHING, POLLING, ETC.) -->
<script type="module">
    const suggestionsContainer = document.getElementById('suggestionsContainer');
    const suggestionsStatus = document.getElementById('suggestionsStatus');

    function renderSuggestions(suggestions) {
        const rowsHtml = suggestions.map(s => {
            return `
                <div class="flex flex-col space-y-1 rounded-2xl border border-white/10 bg-slate-950/60 p-3 text-sm shadow-sm hover:bg-slate-900/80">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-slate-100">${s.ticker} - ${s.name}</span>
                    </div>
                    <p class="text-xs text-slate-300">
                        ${s.rationale}
                        <a href="${s.source_url}" target="_blank" class="ml-1 text-[11px] text-teal-300 hover:text-teal-200 underline">
                            Source
                        </a>
                    </p>
                </div>
            `;
        }).join('');
        suggestionsContainer.innerHTML = rowsHtml;
    }
    function pendingSuggestionsContainer() {
        suggestionsContainer.innerHTML = '';
        suggestionsStatus.textContent = "Fetching today's suggestions...";
    }
    function succeededSuggestionsContainer() {
        suggestionsStatus.textContent = "";
    }
    import { initSuggestions } from "/static/js/suggestions.js";
    document.addEventListener('DOMContentLoaded', async () => {
        initSuggestions({
            basketId: basketId,
            fetchSuggestionsUrl: "/baskets/get-suggestions",
            startJobUrl: "/baskets/generate-suggestions",
            getJobInProgressUrl: "/jobs/get-suggestions-generating",
            getJobUrl: "/jobs/get",
            renderSuggestions: (suggestions) => renderSuggestions(suggestions),
            setStatus: (msg) => {
                suggestionsStatus.textContent = msg;
            },
            showPending: () => pendingSuggestionsContainer(),
            showSucceeded: () => succeededSuggestionsContainer(),
        });
    });
</script>


<script>
    let basketChart = null;
    let fullLabels = [];
    let fullValues = [];
    let currentRange = "1M";

    async function loadBasketChart(basketId) {
        const res = await fetch(`/baskets/performance?basket_id=${basketId}`);
        const data = await res.json();

        fullLabels = data.labels;
        fullValues = data.values;

        const ctx = document.getElementById('basketChart').getContext('2d');

        const initial = filterDataByRange(fullLabels, fullValues, currentRange);

        basketChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: initial.labels,
                datasets: [{
                    data: initial.values,
                    borderWidth: 2,
                    tension: 0.25,
                    pointRadius: 0
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: (items) => items[0].label,
                            label: (item) => `Value: ${item.raw.toFixed(2)}`
                        }
                    }
                },
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        display: true,
                        ticks: {
                            autoSkip: true,
                            maxTicksLimit: getMaxTicks(currentRange), // fewer labels for 3M/1Y
                            color: '#94a3b8',
                            maxRotation: 0,
                            minRotation: 0
                        },
                        grid: {
                            color: 'rgba(148,163,184,0.1)'
                        }
                    },
                    y: {
                        display: true,
                        ticks: {
                            color: '#94a3b8'
                        },
                        grid: {
                            color: 'rgba(148,163,184,0.07)'
                        }
                    }
                }
            }
        });

        initRangeButtons();
    }

    function initRangeButtons() {
        const container = document.getElementById('periodButtons');
        if (!container) return;

        container.addEventListener('click', (e) => {
            const btn = e.target.closest('button[data-range]');
            if (!btn) return;

            const range = btn.dataset.range;
            changeRange(range);
            setActiveButton(range);
        });
    }

    function setActiveButton(range) {
        const buttons = document.querySelectorAll('#periodButtons .range-btn');

        const inactiveClasses = [
            "text-slate-300",
            "hover:text-white",
            "hover:bg-slate-800/80",
            "bg-transparent",
            "border-transparent"
        ];

        const activeClasses = [
            "text-slate-900",
            "bg-teal-400",
            "border-teal-400",
            "shadow-sm",
            "shadow-teal-500/40"
        ];

        buttons.forEach((btn) => {
            const isActive = btn.dataset.range === range;
            btn.classList.remove(
                ...inactiveClasses,
                ...activeClasses,
            );

            if (isActive) {
                btn.classList.remove("hover:text-white", "hover:bg-slate-800/80");
                btn.classList.add(...activeClasses);
            } else {
                btn.classList.add(...inactiveClasses);
            }
        });
    }


    function changeRange(range) {
        if (!basketChart) return;

        currentRange = range;

        const filtered = filterDataByRange(fullLabels, fullValues, range);
        basketChart.data.labels = filtered.labels;
        basketChart.data.datasets[0].data = filtered.values;

        basketChart.options.scales.x.ticks.maxTicksLimit = getMaxTicks(range);

        basketChart.update();
    }

    // Decide how many x-axis labels per range
    function getMaxTicks(range) {
        if (range === "1Y") return 6;   // ~1 label every 2 months
        if (range === "1Y") return 6;
        if (range === "3M") return 7;
        if (range === "1M") return 8;
        if (range === "5D") return 7;
        return 8;
    }

    function filterDataByRange(labels, values, range) {
        const lastDate = new Date(labels[labels.length - 1]);
        let cutoff = new Date(lastDate);

        if (range === "5D") {
            cutoff.setDate(cutoff.getDate() - 5);
        } else if (range === "1M") {
            cutoff.setMonth(cutoff.getMonth() - 1);
        } else if (range === "3M") {
            cutoff.setMonth(cutoff.getMonth() - 3);
        } else if (range === "6M") {
            cutoff.setMonth(cutoff.getMonth() - 6);
        } else if (range === "1Y") {
            cutoff.setFullYear(cutoff.getFullYear() - 1);
        }

        const newLabels = [];
        const newValues = [];

        for (let i = 0; i < labels.length; i++) {
            const d = new Date(labels[i]);
            if (d >= cutoff) {
                newLabels.push(labels[i]);
                newValues.push(values[i]);
            }
        }

        return { labels: newLabels, values: newValues };
    }

    // initial load with default range 1M
    loadBasketChart(basketId);
</script>
