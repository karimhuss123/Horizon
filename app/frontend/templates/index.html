<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Horizon — Create Basket</title>

<!-- Fonts & Tailwind -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<style>
    html { scroll-behavior: smooth; }
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
</style>
</head>

<body class="bg-slate-950 text-white min-h-screen">
    <!-- Decorative horizon gradient background -->
    <div class="pointer-events-none fixed inset-0 -z-10">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950"></div>
        <div class="absolute inset-x-0 top-[-30%] h-[140vh] bg-[radial-gradient(140rem_60rem_at_50%_15%,rgba(45,212,191,0.22),transparent_75%)]"></div>
    </div>

    {% include 'modules/header.html' %}

    <!-- Main -->
    <main class="relative z-10">
        <div class="mx-auto max-w-5xl px-6 py-10 space-y-8">
        <!-- Create box -->
        <section class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur">
            <div class="flex items-center justify-between gap-3">
                <h1 class="text-2xl font-semibold tracking-tight sm:text-3xl">
                    Create a <span class="bg-gradient-to-r from-teal-300 via-cyan-300 to-teal-300 bg-clip-text text-transparent">Basket</span>
                </h1>
                <span class="hidden text-xs text-slate-400 sm:inline">Describe an idea, we generate a basket.</span>
            </div>

            <div class="mt-5">
                <label for="message" class="mb-2 block text-sm font-medium text-slate-200">
                    Idea / Theme
                </label>
                <textarea
                    id="message"
                    maxlength="1000"
                    rows="4"
                    class="w-full rounded-2xl border border-white/10 bg-slate-950/70 px-4 py-3 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                    placeholder="Describe your idea... (e.g., “AI infrastructure”, “Clean energy leaders”)"
                ></textarea>
            </div>

            <div class="mt-4 flex flex-col items-start gap-3 sm:flex-row sm:items-center">
                <button
                    id="submitBtn"
                    class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-5 py-2.5 text-sm font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95 disabled:cursor-not-allowed disabled:opacity-60">
                    Generate
                </button>
                <span id="status" class="text-xs text-slate-400"></span>
            </div>
        </section>

        <!-- Boards: always visible -->
        <section class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur">
            <div class="flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Your Baskets</h2>
            <!-- Tabs -->
            <div class="grid grid-cols-2 gap-3 sm:w-64">
                <button
                    data-filter="Active"
                    id="tabActive"
                    class="tab-btn rounded-xl border border-white/10 bg-slate-900/60 px-4 py-2 text-center text-sm font-medium text-slate-200 transition focus:outline-none">
                    Active
                </button>
                <button
                    data-filter="Draft"
                    id="tabDraft"
                    class="tab-btn rounded-xl border border-white/10 bg-slate-900/60 px-4 py-2 text-center text-sm font-medium text-slate-200 transition focus:outline-none">
                    Draft
                </button>
            </div>
            </div>

            <!-- List area -->
            <div id="basketList" class="mt-5 space-y-4">
            <!-- Basket cards will be injected here -->
            </div>

            <!-- Empty state -->
            <div
                id="emptyState"
                class="hidden mt-6 rounded-2xl border border-dashed border-white/10 bg-slate-900/60 py-8 text-center text-sm text-slate-400">
                No baskets found for this status.
            </div>
        </section>
        </div>
    </main>
</body>
</html>

<script>
    // --- Elements
    const submitBtn = document.getElementById('submitBtn');
    const textarea = document.getElementById('message');
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('basketList');
    const emptyEl = document.getElementById('emptyState');
    const tabBtns = document.querySelectorAll('.tab-btn');

    // --- State
    let allBaskets = [];

    // --- Load saved tab on page load
    const savedTab = localStorage.getItem('activeFilter');
    let activeFilter = savedTab || 'Active'; // default tab if nothing saved

    // --- Update active tab styles & save choice
    function setActiveTab(filter) {
    activeFilter = filter;
    localStorage.setItem('activeFilter', filter);

    tabBtns.forEach(btn => {
        const isActive = btn.dataset.filter === filter;

        btn.classList.toggle('ring-2', isActive);
        btn.classList.toggle('ring-teal-400/70', isActive);
        btn.classList.toggle('bg-slate-900', isActive);
        btn.classList.toggle('bg-slate-900/60', !isActive);
        btn.classList.toggle('text-teal-200', isActive);
        btn.classList.toggle('text-slate-200', !isActive);
    });
    }

    function renderList() {
        listEl.innerHTML = '';
        const items = allBaskets.filter(b => (b.status || 'Active') === activeFilter);

        if (items.length === 0) {
            emptyEl.classList.remove('hidden');
            return;
        }
        emptyEl.classList.add('hidden');

        items.forEach(b => {
            const card = document.createElement('div');
            card.className =
            'group cursor-pointer rounded-2xl border border-white/10 bg-slate-900/60 p-4 transition ' +
            'hover:border-teal-400/60 hover:bg-slate-900/80';

            const holdingsCount = Array.isArray(b.holdings) ? b.holdings.length : 0;
            const desc = b.description || '';
            const status = b.status || 'Draft';
            const statusClass =
            status === 'Active'
                ? 'border-teal-500/40 bg-teal-500/15 text-teal-300'
                : 'border-slate-600/60 bg-slate-800/80 text-slate-300';

            card.innerHTML = `
                <div class="flex items-start justify-between gap-4">
                    <div>
                    <div class="text-base font-semibold text-white">
                        ${b.name || 'Untitled Basket'}
                    </div>
                    <div class="mt-1 text-sm text-slate-300/90 line-clamp-2">
                        ${desc}
                    </div>
                    </div>
                    <div class="shrink-0">
                    <span class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium ${statusClass}">
                        ${status}
                    </span>
                    </div>
                </div>
                <div class="mt-3 text-xs text-slate-400">
                    Holdings:
                    <span class="font-semibold text-slate-200">${holdingsCount}</span>
                </div>
            `;

            card.addEventListener('click', () => {
                const id = b.id;
                if (!id) return;
                window.location.href = `/baskets/details?basket_id=${encodeURIComponent(id)}`;
            });

            listEl.appendChild(card);
        });
    }

    async function fetchAllBaskets() {
        try {
            const res = await fetch('/baskets/get-all');
            if (!res.ok) throw new Error(`GET /baskets/get-all -> ${res.status}`);
            const data = await res.json();
            // Expecting an array of baskets
            allBaskets = Array.isArray(data) ? data : (data.items || []);
            renderList();
        } catch (e) {
            console.error(e);
            allBaskets = [];
            renderList();
        }
    }

    // --- Events
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            setActiveTab(btn.dataset.filter);
            renderList();
        });
    });

    submitBtn.addEventListener('click', async () => {
        const user_prompt = textarea.value.trim();
        if (!user_prompt) {
            statusEl.textContent = 'Please enter a prompt.';
            return;
        }
        if (user_prompt.length < 10) {
            statusEl.textContent = 'Prompt must be at least 10 characters.';
            return;
        }
        statusEl.textContent = '';
        try {
            const existingJob = await fetchGeneratingJob();
            if (existingJob && existingJob.job_id) {
                currentJobId = existingJob.job_id;
                deactivateGenerateBtn();
                pollGeneratingJob(currentJobId);
                return;
            }
        } catch (err) {
            console.error('Failed to check existing job.');
        }
        deactivateGenerateBtn();
        try {
            const res = await fetch('/baskets/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_prompt })
            });
            const data = await res.json();
            if (!res.ok) {
                if (data.detail && data.detail.message) {
                    statusEl.textContent = data.detail.message;
                } else {
                    statusEl.textContent = "Failed to generate. Please try again.";
                }
                activateGenerateBtn();
                return
            };
            currentJobId = data.job_id;
            pollGeneratingJob(currentJobId);
        } catch (err) {
            console.error(err);
            statusEl.textContent = 'Failed to generate. Please try again.';
            activateGenerateBtn();
        }
    });

    let currentJobId = null;
    let jobPollTimeout = null;

    async function fetchGeneratingJob() {
        const res = await fetch('/jobs/get-generating');
        if (!res.ok) {
            return null;
        }
        try {
            const data = await res.json();
            return data || null;
        } catch {
            return null;
        }
    }

    async function pollGeneratingJob(jobId) {
        try {
            const res = await fetch(`/jobs/get?id=${jobId}`);
            if (!res.ok) {
                if (data.detail && data.detail.message) {
                    throw new Error(data.detail.message);
                } else {
                    throw new Error("Job not found.");
                }
            }
            const data = await res.json();
            if (data.status === 'pending' || data.status === 'running') {
                jobPollTimeout = setTimeout(() => pollGeneratingJob(jobId), 2000);
                return;
            }
            currentJobId = null;
            activateGenerateBtn();
            if (data.status === 'succeeded') {
                textarea.value = '';
                await fetchAllBaskets();
                setActiveTab('Draft');
                renderList();
            } else if (data.status === 'failed') {
                const msg = data.error_message || 'Basket generation failed. Please try again.';
                statusEl.textContent = msg;
            }
        } catch (err) {
            console.error(err);
            currentJobId = null;
            activateGenerateBtn();
            statusEl.textContent = 'Basket generation failed. Please try again.';
        }
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const job = await fetchGeneratingJob();
            if (job && job.job_id) {
                currentJobId = job.job_id;
                deactivateGenerateBtn();
                pollGeneratingJob(currentJobId);
            }
        } catch (err) {
            console.error('Failed to initialize generation state.');
        }
    });

    function activateGenerateBtn() {
        submitBtn.textContent = 'Generate';
        submitBtn.disabled = false;
    }

    function deactivateGenerateBtn() {
        submitBtn.textContent = 'Generating...';
        submitBtn.disabled = true;
    }

    setActiveTab(activeFilter);
    fetchAllBaskets();
</script>
