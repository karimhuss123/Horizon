<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Horizon — Edit Basket — {{ basket.name }}</title>

    <!-- Fonts & Tailwind -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- jQuery (required by Select2) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- Select2 CSS + JS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="{{ request.url_for('static', path='styles/select2_styles.css') }}" rel="stylesheet">

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    </style>
</head>

<body class="bg-slate-950 text-white min-h-screen">
    <!-- Decorative horizon gradient background -->
    <div class="pointer-events-none fixed inset-0 -z-10">
        <div class="absolute inset-0 bg-gradient-to-b from-slate-950 via-slate-900 to-slate-950"></div>
        <div class="absolute inset-x-0 top-[-30%] h-[140vh] bg-[radial-gradient(140rem_60rem_at_50%_15%,rgba(45,212,191,0.22),transparent_75%)]"></div>
    </div>

    {% include 'modules/header.html' %}

    <main class="relative z-10">
        <div class="mx-auto max-w-8xl px-6 py-8 space-y-6">
            <!-- Top row: back + title -->
            <div class="grid grid-cols-3 items-center">
                <div class="text-left">
                    <a href="/" class="inline-flex items-center text-xs font-medium text-slate-300 hover:text-white">
                        <span class="mr-1">&larr;</span>
                        Back
                    </a>
                </div>
                <div class="text-center">
                    <h1 class="text-xl font-semibold tracking-tight sm:text-2xl">Edit Basket</h1>
                </div>
                <div class="text-right"></div>
            </div>

            <div class="grid grid-cols-1 gap-6 lg:grid-cols-[1.4fr_1fr]">
                <!-- Basket editor (Left Panel) -->
                <div
                    id="basketCard"
                    class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur"
                    data-basket-id="{{ basket.id }}"
                >
                    <!-- Meta -->
                    <div class="flex items-start justify-between gap-4">
                        <div class="w-full max-w-3xl space-y-3">
                            <div>
                                <label class="mb-1 block text-sm font-medium text-slate-200">Name</label>
                                <input
                                    id="nameInput"
                                    maxlength="200"
                                    type="text"
                                    class="w-full rounded-2xl border border-white/10 bg-slate-950/70 px-3 py-2 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                                    value="{{ basket.name or 'Untitled Basket' }}"
                                />
                            </div>

                            <div>
                                <label class="mb-1 block text-sm font-medium text-slate-200">Description / Thesis</label>
                                <textarea
                                    id="descInput"
                                    maxlength="1500"
                                    rows="3"
                                    class="w-full rounded-2xl border border-white/10 bg-slate-950/70 px-3 py-2 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                                    placeholder="What’s the investment idea?"
                                >{{ basket.description or '' }}</textarea>
                            </div>
                        </div>

                        <div class="shrink-0">
                            <span
                                id="statusPill"
                                class="inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium
                                    {% if basket.status == 'Active' %}
                                        border-teal-500/40 bg-teal-500/15 text-teal-300
                                    {% else %}
                                        border-slate-600/60 bg-slate-800/80 text-slate-300
                                    {% endif %}"
                            >
                                {{ basket.status or "Draft" }}
                            </span>
                        </div>
                    </div>

                    <!-- Holdings table -->
                    <div class="mt-6">
                        <div class="mb-3 flex items-center justify-between gap-3">
                            <h3 class="text-lg font-semibold text-white">Holdings</h3>
                            <div class="flex items-center gap-2">
                                <button
                                    id="addRowBtn"
                                    class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-3 py-1.5 text-xs font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95"
                                >
                                    + Add holding
                                </button>
                                <button
                                    id="normalizeBtn"
                                    class="inline-flex items-center justify-center rounded-xl border border-white/15 bg-slate-900/70 px-3 py-1.5 text-xs font-semibold text-slate-100 shadow-sm hover:bg-slate-900"
                                >
                                    Normalize weights to 100%
                                </button>
                            </div>
                        </div>

                        <div class="overflow-x-auto rounded-2xl border border-white/10 bg-slate-950/60">
                            <table class="min-w-full text-sm" id="holdingsTable">
                                <thead class="bg-slate-900/80">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                            Ticker
                                        </th>
                                        <th class="px-3 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                            Name
                                        </th>
                                        <th class="w-28 px-3 py-2 text-right text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                            Weight %
                                        </th>
                                        <th class="px-3 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                            Rationale
                                        </th>
                                        <th class="w-20 px-3 py-2 text-right text-[11px] font-semibold uppercase tracking-wide text-slate-400">
                                            Actions
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="holdingsBody" class="divide-y divide-slate-800/80">
                                    {% for h in basket.holdings %}
                                        <tr class="hover:bg-slate-900/70">
                                            <td class="px-3 py-2">
                                                <select
                                                    class="ticker-select block w-full min-w-[75px]"
                                                    data-initial-ticker="{{ h.ticker }}"><!-- Options will be populated dynamically --></select>
                                            </td>
                                            <td class="px-3 py-2">
                                                <p class="name w-full text-sm text-slate-200">
                                                    {{ h.name or '' }}
                                                </p>
                                            </td>
                                            <td class="px-3 py-2 text-right">
                                                <input
                                                    type="number"
                                                    step="0.01"
                                                    min="0"
                                                    class="weight w-full rounded-lg border border-white/15 bg-slate-950/80 px-2 py-1.5 text-right text-sm text-slate-100 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                                                    value="{{ '%.2f'|format(h.weight_pct or 0) }}"
                                                />
                                            </td>
                                            <td class="px-3 py-2">
                                                <input
                                                    type="text"
                                                    maxlength="1000"
                                                    class="rationale w-full rounded-lg border border-white/15 bg-slate-950/80 px-2 py-1.5 text-sm text-slate-100 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                                                    value="{{ h.rationale or '' }}"
                                                />
                                            </td>
                                            <td class="px-3 py-2 text-right">
                                                <button class="removeRow text-xs font-medium text-red-300 hover:text-red-200">
                                                    Remove
                                                </button>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3 flex items-center justify-between gap-3">
                            <p id="totals" class="text-xs text-slate-400">
                                Holdings: {{ basket.holdings|length }} • Total weight:
                                <span id="totalWeightSpan" class="font-semibold text-slate-200">
                                    {{
                                        ('%.2f' % (
                                        (basket.holdings | map(attribute='weight_pct') | select('defined') | sum) | default(0)
                                        ))
                                    }}%
                                </span>
                            </p>
                            <p
                                id="weightWarning"
                                class="hidden rounded border border-amber-500/40 bg-amber-900/40 px-2 py-1 text-xs text-amber-200"
                            >
                                Weights should sum to 100%.
                            </p>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-6 flex flex-wrap items-center gap-3">
                        <button
                            id="saveActiveBtn"
                            class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95"
                        >
                            Save as Active
                        </button>
                        <button
                            id="saveDraftBtn"
                            class="inline-flex items-center justify-center rounded-xl border border-white/15 bg-slate-900/70 px-4 py-2 text-xs font-semibold text-slate-100 shadow-sm hover:bg-slate-900"
                        >
                            Save as Draft
                        </button>
                        <span id="actionStatus" class="text-xs text-slate-400"></span>
                    </div>
                </div>

                <!-- Right Panel -->
                <div class="space-y-6">
                    <!-- Reprompting Card -->
                    <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur space-y-4">
                        <h2 class="text-lg font-semibold text-white">Reprompt</h2>
                        <textarea
                            id="userPrompt"
                            maxlength="1000"
                            rows="5"
                            class="w-full rounded-2xl border border-white/10 bg-slate-950/70 px-3 py-2 text-sm text-white placeholder-slate-500 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                            placeholder="Describe your idea..."
                        ></textarea>

                        <div class="flex items-center gap-3">
                            <button
                                id="generateBtn"
                                class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95 disabled:cursor-not-allowed disabled:opacity-60"
                            >
                                Generate
                            </button>
                            <span id="regenerationStatus" class="text-xs text-slate-400"></span>
                        </div>

                        <div id="newBasketCard" class="hidden">
                            <!-- Card inserted dynamically -->
                        </div>
                    </div>

                    <!-- AI Suggestions -->
                    <div class="rounded-3xl border border-white/10 bg-slate-900/70 p-6 shadow-2xl backdrop-blur space-y-4">
                        <h2 class="text-lg font-semibold text-white">Today's AI Suggestions</h2>
                        <div id="suggestionsContainer" class="space-y-2">
                            <!-- Dynamically render suggestions here -->
                        </div>
                        <span id="suggestionsStatus" class="text-xs text-slate-400"></span>
                    </div>
                </div>
            </div>
        </div>
    </main>

</body>
</html>


<script>
    const card = document.getElementById('basketCard');
    const basketId = card.dataset.basketId;
    const nameInput = document.getElementById('nameInput');
    const descInput = document.getElementById('descInput');
    const tbody = document.getElementById('holdingsBody');
    const totalsEl = document.getElementById('totals');
    const totalWeightSpan = document.getElementById('totalWeightSpan');
    const weightWarning = document.getElementById('weightWarning');
    const normalizeBtn = document.getElementById('normalizeBtn');
    const addRowBtn = document.getElementById('addRowBtn');
    const saveActiveBtn = document.getElementById('saveActiveBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const actionStatus = document.getElementById('actionStatus');
    const statusPill = document.getElementById('statusPill');
    const newBasketCard = document.getElementById('newBasketCard');

    function sumWeights() {
        let sum = 0;
        tbody.querySelectorAll('tr').forEach(tr => {
            const w = parseFloat(tr.querySelector('.weight').value) || 0;
            sum += w;
        });
        return sum;
    }

    function updateTotals() {
        const count = tbody.querySelectorAll('tr').length;
        const total = sumWeights();
        totalWeightSpan.textContent = Number(total.toFixed(2)) + '%';
        totalsEl.firstChild.nodeValue = `Holdings: ${count} • Total weight: `;
        if (Math.abs(total - 100) > 0.005) {
            weightWarning.classList.remove('hidden');
        } else {
            weightWarning.classList.add('hidden');
        }
    }

    function addRow(h = {ticker:'', name:'', weight_pct:0, rationale:''}) {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-900/70';
        tr.innerHTML = `
            <td class="px-3 py-2">
                <select
                    class="ticker-select block w-full min-w-[75px]"
                    data-initial-ticker="${h.ticker || ''}"></select>
            </td>
            <td class="px-3 py-2">
                <p class="name w-full text-sm text-slate-200">${h.name || ''}</p>
            </td>
            <td class="px-3 py-2 text-right">
                <input
                    type="number"
                    step="0.01"
                    min="0"
                    class="weight w-full rounded-lg border border-white/15 bg-slate-950/80 px-2 py-1.5 text-right text-sm text-slate-100 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                    value="${Number(h.weight_pct || 0).toFixed(2)}"
                />
            </td>
            <td class="px-3 py-2">
                <input
                    type="text"
                    maxlength="1000"
                    class="rationale w-full rounded-lg border border-white/15 bg-slate-950/80 px-2 py-1.5 text-sm text-slate-100 shadow-inner shadow-black/30 outline-none focus:border-teal-400/60"
                    value="${h.rationale || ''}"
                />
            </td>
            <td class="px-3 py-2 text-right">
                <button class="removeRow text-xs font-medium text-red-300 hover:text-red-200">
                    Remove
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        const lastRow = tbody.lastElementChild;
        const sel = lastRow.querySelector('.ticker-select');
        initSelect2On(sel);

        tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateTotals));
        tr.querySelector('.removeRow').addEventListener('click', () => {
            tr.remove();
            updateTotals();
        });
        updateTotals();
    }

    function getHoldingsFromTable() {
        const rows = [];
        tbody.querySelectorAll('tr').forEach(tr => {
            rows.push({
                ticker: tr.querySelector('.ticker-select').value.trim(),
                weight_pct: parseFloat(tr.querySelector('.weight').value) || 0,
                rationale: tr.querySelector('.rationale').value.trim(),
            });
        });
        return rows;
    }

    function validateHoldings(holdings) {
        if (!Array.isArray(holdings) || holdings.length === 0) {
            return {
                valid: 0,
                errorMsg: "Your basket must include at least one holding before it can be saved."
            };
        }
        let totalWeight = 0;
        for (const h of holdings) {
            const ticker = (h.ticker || "").trim();
            const weight = Number(h.weight_pct);

            if (!ticker || isNaN(weight) || weight <= 0) {
                return {
                    valid: 0,
                    errorMsg: "One or more holdings are invalid. Each holding must include a ticker and a weight greater than zero."
                };
            }
            totalWeight += weight;
        }
        if (Math.abs(totalWeight - 100) > 0.005) {
            return {
                valid: 0,
                errorMsg: "The total weight of all holdings must sum to 100%."
            };
        }
        return {
            valid: 1,
            errorMsg: ""
        };
    }


    function normalizeWeights() {
        const rows = [...tbody.querySelectorAll("tr")];
        if (rows.length === 0) return;
        const total = sumWeights();
        if (total <= 0) return;
        let raw = rows.map(tr => {
            const val = parseFloat(tr.querySelector(".weight").value) || 0;
            return (val / total) * 100;
        });
        let rounded = raw.map(w => parseFloat(w.toFixed(2)));
        let sumRounded = rounded.reduce((a, b) => a + b, 0);
        let diff = parseFloat((100 - sumRounded).toFixed(2));
        const iMax = rounded.indexOf(Math.max(...rounded));
        rounded[iMax] = parseFloat((rounded[iMax] + diff).toFixed(2));
        rows.forEach((tr, i) => {
            tr.querySelector(".weight").value = rounded[i].toFixed(2);
        });
        updateTotals();
    }


    async function save(status) {
        saveActiveBtn.disabled = true;
        saveDraftBtn.disabled = true;

        const nameInputValue = nameInput.value.trim()
        const descInputValue = descInput.value.trim()
        const holdingsList = getHoldingsFromTable()
        const { valid, errorMsg } = validateHoldings(holdingsList);
        if (!valid) {
            actionStatus.textContent = errorMsg;
            return;
        }
        if (!nameInputValue) {
            actionStatus.textContent = 'Basket name cannot be empty.';
            return
        }
        if (descInputValue.length < 10) {
            actionStatus.textContent = 'Basket description must be at least 10 characters.';
            return
        }
        actionStatus.textContent = 'Saving...';
        const payload = {
            id: basketId,
            name: nameInputValue,
            description: descInputValue,
            status: status,
            holdings: getHoldingsFromTable(),
        };

        try {
            const res = await fetch('/baskets/edit', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) {
                if (data.detail && data.detail.message) {
                    actionStatus.textContent = data.detail.message;
                } else {
                    actionStatus.textContent = "Saving failed.";
                }
                return
            };
            window.location.href = `/`;
        } catch (e) {
            console.error(e);
            actionStatus.textContent = 'Saving failed.';
        } finally {
            saveActiveBtn.disabled = false;
            saveDraftBtn.disabled = false;
        }
    }

    // Wire buttons
    addRowBtn.addEventListener('click', () => addRow());
    normalizeBtn.addEventListener('click', normalizeWeights);
    saveActiveBtn.addEventListener('click', () => save('Active'));
    saveDraftBtn.addEventListener('click', () => save('Draft'));

    // Init: ensure inputs update totals on change
    tbody.querySelectorAll('tr').forEach(tr => {
        tr.querySelectorAll('input').forEach(inp => inp.addEventListener('input', updateTotals));
        tr.querySelector('.removeRow').addEventListener('click', () => {
            tr.remove();
            updateTotals();
        });
    });

    function initSelect2On(selectEl) {
        const $sel = $(selectEl);
        $sel.select2({
            width: '100%',
            placeholder: '--',
            allowClear: true,
            minimumInputLength: 1,
            ajax: {
                url: '/securities/get-tickers',
                dataType: 'json',
                delay: 200,
                data: params => ({
                    q: params.term || ''
                }),
                processResults: (data) => {
                    const results = (data || []).map(item => ({
                        id: item.ticker,
                        text: `${item.ticker}`,
                        name: item.name || ''
                    }));
                    return { results };
                },
                cache: true
            },
            templateResult: item => item.text || '',
            templateSelection: item => item.text || item.id || ''
        });

        $sel.on('select2:select', function(e) {
            const name = e?.params?.data?.name || '';
            const row = this.closest('tr');
            const nameCell = row.querySelector('.name');
            const rationaleCell = row.querySelector('.rationale');
            nameCell.textContent = name;
            rationaleCell.value = '';
        });

        $sel.on('select2:clear', function() {
            const row = this.closest('tr');
            const nameCell = row.querySelector('.name');
            const rationaleCell = row.querySelector('.rationale');
            nameCell.textContent = '';
            rationaleCell.value = '';
        });

        // Preselect initial ticker if defined
        const init = selectEl.dataset.initialTicker;
        if (init) {
            const opt = new Option(init, init, true, true);
            selectEl.appendChild(opt);
            $sel.trigger('change');
        }
    }

    updateTotals();
    document.querySelectorAll('.ticker-select').forEach(initSelect2On);
</script>

<!-- SUGGESTIONS LOGIC (FETCHING, POLLING, ETC.) -->
<script type="module">
    const suggestionsContainer = document.getElementById('suggestionsContainer');
    const suggestionsStatus = document.getElementById('suggestionsStatus');

    function renderSuggestions(suggestions) {
        const rowsHtml = suggestions.map(s => {
            let onclickHandler;
            if (s.action === "Add") {
                onclickHandler = `addRow({'ticker': '${s.ticker}', 'name': '${s.name}', 'rationale': '${s.rationale}'})`;
            } else if (s.action === "Update") {
                onclickHandler = `updateSuggestion('${s.ticker}')`;
            } else {
                onclickHandler = `removeSuggestion('${s.ticker}')`;
            }

            return `
                <div class="flex flex-col space-y-1 rounded-2xl border border-white/10 bg-slate-950/60 p-3 text-sm shadow-sm hover:bg-slate-900/80">
                    <div class="flex items-center justify-between">
                        <span class="font-semibold text-slate-100">${s.ticker} - ${s.name}</span>
                        <button
                            class="text-xs font-medium text-teal-300 hover:text-teal-200"
                            onclick="${onclickHandler}"
                        >
                            ${s.action}
                        </button>
                    </div>
                    <p class="text-xs text-slate-300">
                        ${s.rationale}
                        <a href="${s.source_url}" target="_blank" class="ml-1 text-[11px] text-teal-300 hover:text-teal-200 underline">
                            Source
                        </a>
                    </p>
                </div>
            `;
        }).join('');
        suggestionsContainer.innerHTML = rowsHtml;
    }
    function updateSuggestion(ticker) {
        console.log("Updating suggestion for:", ticker);
        // Update logic here
    }
    function removeSuggestion(ticker) {
        console.log("Remove action for:", ticker);
        // Handle other logic
    }

    function pendingSuggestionsContainer() {
        suggestionsContainer.innerHTML = '';
        suggestionsStatus.textContent = "Fetching today's suggestions...";
    }
    function succeededSuggestionsContainer() {
        suggestionsStatus.textContent = "";
    }
    import { initSuggestions } from "/static/js/suggestions.js";
    document.addEventListener('DOMContentLoaded', async () => {
        initSuggestions({
            basketId: basketId,
            fetchSuggestionsUrl: "/baskets/get-suggestions",
            startJobUrl: "/baskets/generate-suggestions",
            getJobInProgressUrl: "/jobs/get-suggestions-generating",
            getJobUrl: "/jobs/get",
            renderSuggestions: (suggestions) => renderSuggestions(suggestions),
            setStatus: (msg) => {
                suggestionsStatus.textContent = msg;
            },
            showPending: () => pendingSuggestionsContainer(),
            showSucceeded: () => succeededSuggestionsContainer(),
        });
    });
</script>



<script>
    generateBtn = document.getElementById('generateBtn');
    regenerationStatus = document.getElementById('regenerationStatus')
    generateBtn.addEventListener('click', async () => {
        const user_prompt = document.getElementById('userPrompt').value.trim();
        const name = nameInput.value.trim()
        const description = descInput.value.trim()
        const holdings = getHoldingsFromTable()
        const { valid, errorMsg } = validateHoldings(holdings);

        if (!user_prompt) {
            setRegenerationStatusMsg('Please enter a prompt.');
            return;
        }
        if (user_prompt.length < 10) {
            setRegenerationStatusMsg('Prompt must be at least 10 characters.')
            return;
        }
        if (!valid) {
            setRegenerationStatusMsg(errorMsg);
            return;
        }
        if (!name) {
            setRegenerationStatusMsg('Basket name cannot be empty.');
            return
        }
        if (description.length < 10) {
            setRegenerationStatusMsg("Basket description must be at least 10 characters.");
            return
        }
        try {
            const existingJobRegen = await fetchRegeneratingJob();
            if (existingJobRegen && existingJobRegen.job_id) {
                deactivateRegenerateBtn();
                pollRegeneratingJob(existingJobRegen.job_id);
                return;
            }
        } catch (err) {
            console.error('Failed to check existing job.');
        }
        try {
            const hasRegeneration = await fetchRegenerationForBasket(basketId);
            if (hasRegeneration) {
                await rejectRegeneration(hasRegeneration.id);
                clearRegeneration();
            }
        } catch {
            console.error('Failed to reject existing regeneration.');
        }
        deactivateRegenerateBtn();
        try {
            const payload = {
                basket_id: basketId,
                name: name,
                description: description,
                holdings: holdings,
                user_prompt: user_prompt
            };
            const res = await fetch('/baskets/regenerate', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) {
                if (data.detail && data.detail.message) {
                    setRegenerationStatusMsg(data.detail.message);
                } else {
                    setRegenerationStatusMsg('Failed to regenerate.');
                }
                activateRegenerateBtn();
                return
            };
            pollRegeneratingJob(data.job_id);
        } catch (e) {
            console.error(e);
            setRegenerationStatusMsg("Failed to regenerate.");
            activateRegenerateBtn();
        }
    });

    function renderSuggestedBasket(suggested_basket) {
        const card = document.getElementById('newBasketCard');
        const userPrompt = document.getElementById('userPrompt');
        if (!card) return;

        card.className = '';
        card.classList.add('mt-4', 'rounded-3xl', 'border', 'border-white/10', 'bg-slate-900/70', 'p-6', 'shadow-2xl', 'backdrop-blur');

        const hasDesc = Boolean(suggested_basket.description && suggested_basket.description.trim());
        const holdings = Array.isArray(suggested_basket.holdings) ? suggested_basket.holdings : [];

        const rowsHtml = holdings.map(h => `
            <tr class="hover:bg-slate-900/70">
                <td class="px-4 py-2 text-sm font-medium text-slate-100">${h.ticker ?? '—'}</td>
                <td class="px-4 py-2 text-sm text-slate-200">${h.name ?? '—'}</td>
                <td class="px-4 py-2 text-right text-sm tabular-nums text-slate-200">${Number(h.weight_pct || 0).toFixed(2)}%</td>
                <td class="px-4 py-2 text-sm text-slate-300">${h.rationale ?? ''}</td>
            </tr>
        `).join('');

        card.innerHTML = `
            <div class="flex items-start justify-between gap-4">
                <div>
                    <h2 class="text-xl font-semibold text-white">
                        ${suggested_basket.name || 'Untitled Basket'}
                    </h2>
                    ${hasDesc ? `<p class="mt-1 text-sm text-slate-300">${suggested_basket.description}</p>` : ''}
                </div>
            </div>

            <div class="mt-6 overflow-x-auto rounded-2xl border border-white/10 bg-slate-950/60">
                <table class="min-w-full text-sm">
                    <thead class="bg-slate-900/80">
                        <tr>
                            <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">Ticker</th>
                            <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">Name</th>
                            <th class="px-4 py-2 text-right text-[11px] font-semibold uppercase tracking-wide text-slate-400">Weight</th>
                            <th class="px-4 py-2 text-left text-[11px] font-semibold uppercase tracking-wide text-slate-400">Rationale</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-800/80">
                        ${rowsHtml}
                    </tbody>
                </table>
            </div>

            <p class="mt-3 text-xs text-slate-400">
                Holdings:
                <span class="font-semibold text-slate-200">${holdings.length}</span>
            </p>

            <input type="hidden" id="regenerationId" value="${suggested_basket.id || ''}" />

            <div class="mt-4 flex flex-wrap items-center gap-3">
                <button
                    id="suggestAcceptBtn"
                    class="inline-flex items-center justify-center rounded-xl bg-gradient-to-r from-teal-400 to-cyan-400 px-4 py-2 text-xs font-semibold text-slate-950 shadow-lg shadow-teal-500/30 transition hover:opacity-95"
                >
                    Accept
                </button>
                <button
                    id="suggestRejectBtn"
                    class="inline-flex items-center justify-center rounded-xl border border-red-500/40 bg-red-600/20 px-4 py-2 text-xs font-semibold text-red-200 shadow-sm hover:bg-red-600/30"
                >
                    Reject
                </button>
                <span id="suggestActionStatus" class="text-xs text-slate-400"></span>
            </div>
        `;

        const actionStatus = document.getElementById('suggestActionStatus');
        document.getElementById('suggestAcceptBtn').onclick = async () => {
            actionStatus.textContent = 'Accepting…';
            acceptRegeneration(suggested_basket.id);
            clearRegeneration();
            nameInput.value = suggested_basket.name || '';
            descInput.value = suggested_basket.description || '';
            tbody.innerHTML = '';
            suggested_basket.holdings.forEach(h => addRow(h));
            setRegenerationStatusMsg('Suggested basket accepted.')
            userPrompt.value = '';
            updateTotals();
        };
        document.getElementById('suggestRejectBtn').onclick = async () => {
            actionStatus.textContent = 'Rejecting...';
            rejectRegeneration(suggested_basket.id)
            clearRegeneration();
            setRegenerationStatusMsg('Suggested basket rejected.')
            userPrompt.value = '';
        };
    }

    async function acceptRegeneration(id) {
        const res = await fetch('/baskets/accept-regeneration', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
    }

    async function rejectRegeneration(id) {
        const res = await fetch('/baskets/reject-regeneration', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({id})
        });
    }

    async function fetchRegenerationForBasket(basketId) {
        const res = await fetch(`/baskets/get-regeneration?basket_id=${basketId}`);
        if (!res.ok) return false;
        const data = await res.json();
        if (!data) {
            return false;
        }
        return data;
    }

    async function fetchRegeneratingJob() {
        const res = await fetch(`/jobs/get-regenerating?basket_id=${basketId}`);
        if (!res.ok) {
            return null;
        }
        try {
            const data = await res.json();
            return data || null;
        } catch {
            return null;
        }
    }

    async function pollRegeneratingJob(jobId) {
        try {
            const res = await fetch(`/jobs/get?id=${jobId}`);
            if (!res.ok) {
                if (data.detail && data.detail.message) {
                    throw new Error(data.detail.message);
                } else {
                    throw new Error("Job not found.");
                }
            }
            const data = await res.json();
            if (data.status === 'pending' || data.status === 'running') {
                jobPollTimeout = setTimeout(() => pollRegeneratingJob(jobId), 2000);
                return;
            }
            if (data.status === 'succeeded') {
                const regeneration = await fetchRegenerationForBasket(basketId);
                renderSuggestedBasket(regeneration);
            } else if (data.status === 'failed') {
                const msg = data.error_message || 'Basket regeneration failed. Please try again.';
                setRegenerationStatusMsg(msg);
            }
            activateRegenerateBtn();
        } catch (err) {
            console.error(err);
            activateRegenerateBtn();
            setRegenerationStatusMsg('Basket generation failed. Please try again.');
        }
    }

    function activateRegenerateBtn() {
        generateBtn.textContent = 'Generate';
        generateBtn.disabled = false;
    }

    function deactivateRegenerateBtn() {
        newBasketCard.innerHTML = '';
        newBasketCard.className = '';
        newBasketCard.classList.add('hidden')
        generateBtn.textContent = 'Generating...';
        generateBtn.disabled = true;
        setRegenerationStatusMsg('');
    }

    function setRegenerationStatusMsg(msg) {
        regenerationStatus.textContent = msg;
    }

    function clearRegeneration() {
        newBasketCard.innerHTML = '';
        newBasketCard.className = '';
        newBasketCard.classList.add('hidden');
    }


    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const regeneration = await fetchRegenerationForBasket(basketId)
            if (regeneration) {
                renderSuggestedBasket(regeneration);
            };
            const job = await fetchRegeneratingJob();
            if (job && job.job_id) {
                deactivateRegenerateBtn();
                pollRegeneratingJob(job.job_id);
            }
        } catch (err) {
            console.error('Failed to initialize regeneration state.');
        }
    });
</script>